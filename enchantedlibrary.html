<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Enchanted Library - Moon Loom</title>
    <style>
        /* Reset */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
            background: linear-gradient(135deg, #1a1a2e, #3b2a6d);
            color: #e0d7f5;
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            background: rgba(58, 24, 97, 0.9);
            border-radius: 12px;
            padding: 2rem;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 0 20px #7c3aed;
        }

        h1, h2, h3 {
            color: #d8b4fe;
            margin-bottom: 1rem;
            text-align: center;
            text-shadow: 0 0 8px #9f7aea;
        }

        section {
            margin-bottom: 2rem;
        }

        ul {
            list-style: none;
            padding: 0;
            margin: 0 auto;
            max-width: 700px;
        }

        ul li {
            background: #5b4b8a;
            margin-bottom: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            box-shadow: inset 0 0 10px #7c3aed;
            word-wrap: break-word;
        }

        form {
            max-width: 700px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.25rem;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 0.5rem;
            border-radius: 6px;
            border: none;
            font-size: 1rem;
            font-family: inherit;
            box-shadow: inset 0 0 5px #7c3aed;
            background: #3b2a6d;
            color: #e0d7f5;
            resize: vertical;
        }

        button {
            background: #9f7aea;
            color: #1a1a2e;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 10px #9f7aea;
            transition: background-color 0.3s ease;
            align-self: flex-start;
        }

        button:hover, button:focus {
            background: #7c3aed;
            color: #fff;
            outline: none;
        }

        .edit-btn, .delete-btn {
            background-color: #6b46c1;
            color: #e0d7f5;
            border: none;
            padding: 0.3rem 0.75rem;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 0 5px #9f7aea;
            margin-right: 0.5rem;
            transition: background-color 0.3s ease;
        }

        .edit-btn:hover, .edit-btn:focus {
            background-color: #553c9a;
            outline: none;
        }

        .delete-btn {
            background-color: #9d2f2f;
        }

        .delete-btn:hover, .delete-btn:focus {
            background-color: #7a2424;
            outline: none;
        }

        .button-group {
            margin-top: 0.5rem;
        }

        #discussion-list li {
            background: #4c3a7a;
            margin-bottom: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            box-shadow: inset 0 0 5px #7c3aed;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <main class="container" role="main" aria-labelledby="page-title">
        <h1 id="page-title">Enchanted Library</h1>

        <section aria-labelledby="book-recommendations-title">
            <h2 id="book-recommendations-title">Book Recommendations</h2>
            <ul>
                <li><strong><a href="https://www.goodreads.com/book/show/9361589-the-night-circus" target="_blank" rel="noopener noreferrer">The Night Circus</a></strong> by Erin Morgenstern - A magical tale of a mysterious circus and star-crossed lovers.</li>
                <li><strong><a href="https://www.goodreads.com/book/show/3831.Stardust" target="_blank" rel="noopener noreferrer">Stardust</a></strong> by Neil Gaiman - A whimsical fantasy about a young man's quest in a magical realm.</li>
                <li><strong><a href="https://www.goodreads.com/book/show/157232.Jonathan_Strange_and_Mr_Norrell" target="_blank" rel="noopener noreferrer">Jonathan Strange & Mr Norrell</a></strong> by Susanna Clarke - A story of English magicians in the 19th century.</li>
                <li><strong><a href="https://www.goodreads.com/book/show/157232.Jonathan_Strange_and_Mr_Norrell" target="_blank" rel="noopener noreferrer">The Ocean at the End of the Lane</a></strong> by Neil Gaiman - A haunting tale blending memory and magic.</li>
            </ul>
        </section>

        <section aria-labelledby="reading-challenges-title">
            <h2 id="reading-challenges-title">Reading Challenges</h2>
            <ul>
                <li>Read a book about the moon.</li>
                <li>Read a book with a mystical creature.</li>
                <li>Read a book set in a magical forest.</li>
                <li>Read a book featuring a witch or wizard.</li>
            </ul>
        </section>

        <section aria-labelledby="monthly-book-club-title">
            <h2 id="monthly-book-club-title">Monthly Book Club</h2>
            <p style="max-width:700px; margin: 0 auto 1rem auto; text-align:center;">
                This month's featured book is <strong>"The Starless Sea"</strong> by Erin Morgenstern. Join the discussion below!
            </p>
            <form id="discussion-form" novalidate>
                <label for="discussion-input">Share your thoughts or questions:</label>
                <textarea id="discussion-input" rows="3" placeholder="Write your comment here..." required aria-required="true"></textarea>
                <button type="submit">Post Comment</button>
            </form>
            <ul id="discussion-list" aria-live="polite" aria-atomic="true" tabindex="0">
                <!-- Discussion comments will appear here -->
            </ul>
        </section>

        <section aria-labelledby="user-reviews-title">
            <h2 id="user-reviews-title">User Reviews & Stories</h2>
            <form id="review-form" novalidate>
                <label for="review-title">Title</label>
                <input type="text" id="review-title" placeholder="Enter title" required aria-required="true" />
                <label for="review-link">Link (optional)</label>
                <input type="url" id="review-link" placeholder="Enter URL to your story or review" />
                <label for="review-content">Review or Story</label>
                <textarea id="review-content" rows="4" placeholder="Write your review or story..." required aria-required="true"></textarea>
                <button type="submit">Submit</button>
            </form>
            <ul id="reviews-list" aria-live="polite" aria-atomic="true" tabindex="0">
                <!-- User reviews will appear here -->
            </ul>
        </section>
    </main>

    <script>
        (() => {
            // Discussion comments
            const discussionForm = document.getElementById('discussion-form');
            const discussionInput = document.getElementById('discussion-input');
            const discussionList = document.getElementById('discussion-list');

            // User reviews
            const reviewForm = document.getElementById('review-form');
            const reviewTitle = document.getElementById('review-title');
            const reviewContent = document.getElementById('review-content');
            const reviewsList = document.getElementById('reviews-list');

            // Load and render discussion comments
            const loadDiscussions = () => {
                const discussions = JSON.parse(localStorage.getItem('libraryDiscussions')) || [];
                renderDiscussions(discussions);
            };

            const saveDiscussions = (discussions) => {
                localStorage.setItem('libraryDiscussions', JSON.stringify(discussions));
            };

            const renderDiscussions = (discussions) => {
                discussionList.innerHTML = '';
                if (discussions.length === 0) {
                    discussionList.innerHTML = '<li>No comments yet.</li>';
                    return;
                }
                discussions.forEach((comment, index) => {
                    const li = document.createElement('li');
                    li.textContent = comment;
                    discussionList.appendChild(li);
                });
            };

            discussionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const comment = discussionInput.value.trim();
                if (!comment) return;
                const discussions = JSON.parse(localStorage.getItem('libraryDiscussions')) || [];
                discussions.push(comment);
                saveDiscussions(discussions);
                renderDiscussions(discussions);
                discussionForm.reset();
            });

            // Load and render user reviews with edit/delete
            const loadReviews = () => {
                const reviews = JSON.parse(localStorage.getItem('libraryReviews')) || [];
                renderReviews(reviews);
            };

            const saveReviews = (reviews) => {
                localStorage.setItem('libraryReviews', JSON.stringify(reviews));
            };

            const renderReviews = (reviews) => {
                reviewsList.innerHTML = '';
                if (reviews.length === 0) {
                    reviewsList.innerHTML = '<li>No reviews yet.</li>';
                    return;
                }
                reviews.forEach((review, index) => {
                    const li = document.createElement('li');
                    const linkHTML = review.link ? `<br><a href="${review.link}" target="_blank" rel="noopener noreferrer">Read more</a>` : '';
                    li.innerHTML = `
                        <strong>${review.title}</strong>${linkHTML}<br>
                        <div class="content">${review.content}</div>
                        <div class="button-group">
                            <button class="edit-btn" data-index="${index}" aria-label="Edit review titled ${review.title}">Edit</button>
                            <button class="delete-btn" data-index="${index}" aria-label="Delete review titled ${review.title}">Delete</button>
                        </div>
                    `;
                    reviewsList.appendChild(li);
                });

                // Attach event listeners for edit and delete buttons
                const editButtons = reviewsList.querySelectorAll('.edit-btn');
                const deleteButtons = reviewsList.querySelectorAll('.delete-btn');

                editButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = btn.getAttribute('data-index');
                        startEditReview(idx);
                    });
                });

                deleteButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idx = btn.getAttribute('data-index');
                        deleteReview(idx);
                    });
                });
            };

            reviewForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const title = reviewTitle.value.trim();
                const link = document.getElementById('review-link').value.trim();
                const content = reviewContent.value.trim();

                if (!title || !content) {
                    alert('Please fill in all required fields.');
                    return;
                }

                if (reviewForm.dataset.editIndex !== undefined) {
                    // Editing existing review
                    const editIndex = parseInt(reviewForm.dataset.editIndex, 10);
                    const reviews = JSON.parse(localStorage.getItem('libraryReviews')) || [];
                    reviews[editIndex] = { title, link, content };
                    saveReviews(reviews);
                    renderReviews(reviews);
                    reviewForm.reset();
                    delete reviewForm.dataset.editIndex;
                    reviewForm.querySelector('button[type="submit"]').textContent = 'Submit';
                } else {
                    // Adding new review
                    const reviews = JSON.parse(localStorage.getItem('libraryReviews')) || [];
                    reviews.push({ title, link, content });
                    saveReviews(reviews);
                    renderReviews(reviews);
                    reviewForm.reset();
                }
            });

            function startEditReview(index) {
                const reviews = JSON.parse(localStorage.getItem('libraryReviews')) || [];
                const review = reviews[index];
                if (!review) return;
                reviewTitle.value = review.title;
                document.getElementById('review-link').value = review.link || '';
                reviewContent.value = review.content;
                reviewForm.dataset.editIndex = index;
                reviewForm.querySelector('button[type="submit"]').textContent = 'Save Changes';
                reviewTitle.focus();
            }

            function deleteReview(index) {
                const reviews = JSON.parse(localStorage.getItem('libraryReviews')) || [];
                if (index < 0 || index >= reviews.length) return;
                if (confirm(`Are you sure you want to delete "${reviews[index].title}"?`)) {
                    reviews.splice(index, 1);
                    saveReviews(reviews);
                    renderReviews(reviews);
                    if (reviewForm.dataset.editIndex == index) {
                        reviewForm.reset();
                        delete reviewForm.dataset.editIndex;
                        reviewForm.querySelector('button[type="submit"]').textContent = 'Submit';
                    }
                }
            }

            // Initialize
            loadDiscussions();
            loadReviews();
        })();
    </script>
</body>
</html>
